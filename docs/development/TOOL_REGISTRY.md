# Tool Registry System

## Overview

The tool registry system ensures all MCP tools are properly exposed everywhere (stdio transport, HTTP transport, and gateway routing). It prevents forgetting to register new tools and provides automatic routing in the gateway.

**Note:** All tool names are prefixed with system identifiers (e.g., `github_`, `calendar_`, `gmail_`, `drive_`, `supabase_`) for clarity in Claude's UI.

## Architecture

The registry system consists of four main components:

1. **Registry (`src/tools/registry.ts`)**: Single source of truth listing all tool names and handlers
2. **Generated Constants (`src/tools/registry-constants.ts`)**: Lightweight tool names array for gateway routing
3. **Validation Script (`scripts/validate-tools.ts`)**: Checks that all tools are registered everywhere
4. **Build Integration**: Auto-generates constants before build

## Why Generated Constants?

The gateway needs to know which tools belong to GitHub for routing, but it can't import the full registry because:

- **Cloudflare Workers Compatibility**: Importing the full registry causes issues in Cloudflare Workers (module resolution, circular dependencies, or size limits)
- **Lightweight Import**: The gateway only needs tool names, not the handlers
- **Automatic Updates**: When tools are added to the registry, constants are regenerated automatically

The generated constants file (`registry-constants.ts`) exports just the tool names array, which the gateway can safely import.

## How It Works

### 1. Registry (`src/tools/registry.ts`)

All tools are registered in one place:

```typescript
export const TOOL_HANDLERS: Record<string, ToolHandler | ToolHandlerWithWindow> = {
  github_create_issue: issuesTools.createIssue,
  github_list_issues: issuesTools.listIssues,
  // ... all tools (all prefixed with github_)
};

export function getAllToolNames(): string[] {
  return Object.keys(TOOL_HANDLERS);
}
```

### 2. Generated Constants (`src/tools/registry-constants.ts`)

**‚ö†Ô∏è AUTO-GENERATED FILE - DO NOT EDIT MANUALLY**

Generated by `scripts/generate-registry-constants.ts` before each build. Contains:

```typescript
export const GITHUB_TOOL_NAMES = [
  'github_actions_get',
  'github_actions_list',
  'github_create_issue',
  // ... all tool names (all prefixed with github_)
] as const;

export type GitHubToolName = typeof GITHUB_TOOL_NAMES[number];

export function isGitHubToolName(name: string): name is GitHubToolName {
  return GITHUB_TOOL_NAMES.includes(name as GitHubToolName);
}
```

### 3. Gateway Routing (`packages/mcp-gateway/src/index.ts`)

The gateway imports the generated constants for routing:

```typescript
import { GITHUB_TOOL_NAMES } from '../../mcp-github/src/tools/registry-constants.js';

// Route based on tool name
if (GITHUB_TOOL_NAMES.includes(toolName)) {
  return 'github';
}
```

**‚úÖ New tools are automatically routed - no manual gateway changes needed!**

### 4. Build Process

The build process automatically generates constants:

```json
{
  "scripts": {
    "generate-registry-constants": "tsx scripts/generate-registry-constants.ts",
    "prebuild": "npm run generate-registry-constants",
    "build": "tsc"
  }
}
```

When you run `npm run build`, it:
1. Runs `prebuild` hook ‚Üí generates `registry-constants.ts`
2. Runs `build` ‚Üí compiles TypeScript (including generated constants)

## Adding a New Tool

When adding a new tool, follow these steps:

### 1. Implement the Tool Handler

Create or update a file in `src/tools/`:

```typescript
// src/tools/my-new-tool.ts
import type { Octokit } from '@octokit/rest';
import type { CallToolResult } from '@modelcontextprotocol/sdk/types.js';

export async function myNewTool(
  octokit: Octokit,
  args: Record<string, any>
): Promise<CallToolResult> {
  // Implementation
  return {
    content: [{ type: 'text', text: 'Result' }]
  };
}
```

### 2. Add to Registry

Add to `src/tools/registry.ts`:

```typescript
import * as myNewToolModule from './my-new-tool.js';

export const TOOL_HANDLERS: Record<string, ToolHandler | ToolHandlerWithWindow> = {
  // ... existing tools
  github_my_new_tool: myNewToolModule.myNewTool,  // Note: prefix with github_
};
```

### 3. Register in index.ts (stdio transport)

Add tool schema and case in `src/index.ts`:

```typescript
// In tools array (around line 100-200):
{
  name: 'github_my_new_tool',  // Note: prefix with github_
  description: 'Description of what it does',
  inputSchema: {
    type: 'object',
    properties: {
      // ... schema
    },
    required: ['param1']
  },
}

// In switch statement (around line 400-500):
case 'github_my_new_tool':  // Note: prefix with github_
  return await myNewToolModule.myNewTool(octokit, args);
```

### 4. Register in worker.ts (HTTP transport)

Same as step 3, but in `src/worker.ts`:

```typescript
// In tools array
{
  name: 'github_my_new_tool',  // Note: prefix with github_
  // ... same schema
}

// In switch statement
case 'github_my_new_tool':  // Note: prefix with github_
  return await myNewToolModule.myNewTool(octokit, args);
```

### 5. Add to Gateway Handler

Add case in `packages/mcp-gateway/src/mcp-handlers.ts`:

```typescript
case 'github_my_new_tool':  // Note: prefix with github_
  return await myNewToolModule.myNewTool(octokit, args);
```

**Note:** Gateway routing is automatic (uses `GITHUB_TOOL_NAMES`), but you still need to add the handler.

### 6. Regenerate Constants

Run the generation script (or let build do it):

```bash
npm run generate-registry-constants
```

This updates `registry-constants.ts` with your new tool.

### 7. Validate

Run the validation script:

```bash
npm run validate-tools
```

This checks that:
- ‚úÖ Tool is in registry
- ‚úÖ Tool is registered in index.ts
- ‚úÖ Tool is registered in worker.ts
- ‚úÖ Tool is in generated constants (auto-checked)
- ‚úÖ Tool is routed in gateway (automatic via constants)
- ‚úÖ Tool has handler in gateway

## Validation Script

The validation script (`scripts/validate-tools.ts`) automatically checks:

- ‚úÖ All tools in registry are registered in `index.ts` (stdio)
- ‚úÖ All tools in registry are registered in `worker.ts` (HTTP)
- ‚úÖ Generated constants match registry (same tools, same order)
- ‚úÖ All tools in registry are routed in gateway (via `GITHUB_TOOL_NAMES`)
- ‚úÖ All tools in registry have handlers in gateway

Run it before committing:

```bash
npm run validate-tools
```

**Output on success:**
```
‚úÖ All tools are properly registered!

Total tools: 26
  - Registry: ‚úÖ
  - index.ts: ‚úÖ
  - worker.ts: ‚úÖ
  - gateway routing: ‚úÖ
  - gateway handlers: ‚úÖ
```

**Output on failure:**
```
üî¥ Tool Validation Failed!

Missing tool registrations:
  ‚ùå Tool 'github_my_new_tool' missing in index.ts switch statement
  ‚ùå Tool 'github_my_new_tool' missing in worker.ts switch statement

Total: 2 error(s)
```

## Generated Constants Script

The `generate-registry-constants.ts` script:

1. Reads `src/tools/registry.ts`
2. Extracts all tool names from `TOOL_HANDLERS` object
3. Generates `src/tools/registry-constants.ts` with:
   - `GITHUB_TOOL_NAMES` array (sorted, deduplicated)
   - `GitHubToolName` type
   - `isGitHubToolName()` helper function

**Run manually:**
```bash
npm run generate-registry-constants
```

**Auto-run:** Executes automatically before build via `prebuild` hook.

## Benefits

1. **Single Source of Truth**: Registry lists all tools in one place
2. **Automatic Routing**: Gateway uses generated constants (no manual routing needed)
3. **Validation**: Script catches missing registrations before commit
4. **Documentation**: Clear process for adding tools
5. **Type Safety**: Generated types ensure tool names are correct
6. **Cloudflare Compatible**: Lightweight constants import works in Workers

## Current Tools

See `packages/mcp-github/src/tools/registry.ts` for the complete list of all registered tools.

As of the last update, there are **27 tools** (all prefixed with `github_`) covering:
- Issues (create, list, get, update, add comment)
- Repositories (list, get)
- Pull Requests (create, list, get, merge)
- Actions (list, get, run/trigger, get logs)
- Files (get contents, list directory, create/update, delete)
- Commits (list, get)
- Diffs (compare commits, get commit diff, get PR diff)
- Code Search
- File Tree (get tree, get raw URL)

## Troubleshooting

### "Generated constants out of sync with registry"

**Solution:** Run `npm run generate-registry-constants` to regenerate.

### "Tool missing in gateway routing"

**Solution:** 
1. Ensure tool is in registry
2. Run `npm run generate-registry-constants`
3. Verify gateway imports `GITHUB_TOOL_NAMES` from `registry-constants.ts`

### "Module not found: registry-constants"

**Solution:** 
1. Run `npm run generate-registry-constants` to create the file
2. Or run `npm run build` (which auto-generates it)

### "Tool missing in index.ts/worker.ts"

**Solution:** Add the tool to both files following the pattern in step 3-4 above.

## Related Documentation

- **Package-level docs**: `packages/mcp-github/TOOL_REGISTRY.md` - Quick reference
- **Development Guide**: `docs/development/GUIDE.md` - General development workflow
- **Porting Guide**: `docs/development/PORTING.md` - Porting tools from Go

